**Проект построен на основе laravel 8. Вебсокет работает на linux**

### Запуск проекта через консоль

+ Создать в СУБД MySQL базу *offer-tracker*. Либо использовать дамп БД в */storage*. Учетные данные для подключения к БД в файле *.env.* (При желании можно прописать своего пользователя)

```
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=offer-tracker
DB_USERNAME=admin
DB_PASSWORD=@admin@
```
+ сделать миграцию таблиц, если не использовался дамп.
``php artisan migrate --seed``

+ В файле *.env* в параметре ``TIMEZONE`` прописать номер часового пояса сервера, где запускается проект. В противном случае дата в БД и серверной части кода будет различаться, не будет корректно отображаться статистика офферов и подписок.
+ В файле *.env* в параметре ``WEBSOCKET_PORT``, ``WEBSOCKET_ADDR`` прописать свой порт, если указанный занят.
+ запуск проекта через консоль: ``php artisan serve``
+ если нужно остановить проект полностью, нужно дополнительно выполнить ``pkill -f offer-service`` для остановки вебсокета.


**Приложение SF-AdTech** — трекер трафика, созданный для организации взаимодействия рекламодателей, которые хотят привлечь к себе на сайт посетителей, и веб-мастеров. 

#### Структура сайта

+ Главная */*
    ++ Страница регистрации */register*
    ++ Страница входа */login*
    ++ Профиль */dashboard*
        ++ Администратор
            +++ Пользователи */users*
            +++ Темы офферов */offer-theme*
        ++ Рекламодатель
            +++ Добавить оффер */offer/create*
            +++ Статистика */offer/statistics*
        ++ Веб-мастер
            +++ Статистика */offer/statistics*

### Пользователи

База данных (БД) имеет четыре таблицы для пользователей: пользователи (``users``), роли (``user_roles``), рекламодатели (``advertisers``), веб-мастеры (``webmasters``). Есть три роли пользователя: *рекламодатель*, *веб-мастер*, *администратор*. Можно зарегистирироваться как рекламодатель или веб-мастер, только администратор может создать нового администратора. Таблица рекламодателей и веб-мастеров создана для разделения отношений. БД имеет следующие отношения: таблица офферов ``offers`` -> таблица рекламодателей ``advertisers`` -> таблица пользователей ``users`` и таблица подписок на офферы ``offer_subscriptions`` -> таблица веб-мастеров ``webmasters`` -> таблица пользователей ``users``.

Регистрация пользователя происходит через средства Laravel, контроллер регистрации - ``App\Http\Controllers\Auth\RegisteredUserController``. Добавлена защита от подделки данных: проверяется, что выбрана роль рекламодатель или веб-мастер. Иначе редирект а страницу 404. В зависимости от роли добавляется запись в *advertisers* или *webmasters*. В случае успешной регистрации вебсокет отправляет клиенту-администратору сообщение *NEW_REGISTRATION* о появлении нового пользователя. На странице администратора появляется новый пользователь. 

Авторизация пользователя вынесена в контроллер пользователей - ``App\Http\Controllers\UserController``, метод ``authenticate``. При авторизации проверяется наличие пользователя в системе и активность учетной записи, которую может выключить администратор.

Администратор может отключить и удалить учетную запись. В случае удаления удаляются все связанные данные. Страницы сайта кроме главной страницы могут просматривать только авторизованные пользователи.

### Рекламодатели и веб-мастеры

Рекламодатель создаёт предложение (*offer*), определяя URL страницы, на которую он хочет приводить людей. В offer-е он указывает стоимость перехода по ссылке. Система определяет комиссию за свои услуги. Вебмастера видят ту долю стоимости оффера, которую получат они. Рекламодатель может включать/выключать и удалять свои офферы. При создании оффера или переключении его статуса, на страницах вебмастеров данные обновляются без перезагрузки. При удалении оффера удаляются все записи о нем (подписки, переходы, из статистики системы и рекламодателя), исчезают с главной страницы и страниц веб-мастеров. При выключении оффер пропадает из страницы веб-мастеров, независимо того, подписаны ли они. Если сервер совершает описанные выше действия, то отправляет эту информацию клиентам (браузерам) через вебсокет. Браузер при получении информации из вебсокета динамически изменит содержание страницы.

Веб-мастера в системе видят активные офферы, подписываются на них, после чего система выдаёт им специальные ссылки, которые они должны разместить в любом виде у себя на ресурсе. Ссылка эта ведёт не на целевой URL, а на систему-редиректор, которая фиксирует переход, а затем перенаправляет клиента на страницу сайта рекламодателя.

### Dashboard

При входе на страницу */dashboard* рекламодатель и веб-мастер видят схожую по структуре таблицу. За отображение страницы отвечает одиночный контроллер ``App\Http\Controllers\DashboardController``. Рекламодатель видит список созданных им офферов, веб-мастер - список подписок и видимых офферов (выключенные офферы не отображаются). Таблица имеет две колонки, которые отображают активность. Для изменения статуса нужно мышью перенести оффер или подписку в соответствующую колонку. У каждого оффера рекламодателя отображается число подписчиков и кнопка удаления. За добавление, удаление, изменение активности офферов отвечает ресурсный контроллер ``App\Http\Controllers\OfferController``, изменение подписок - сервис ``App\Services\SubscriptionService``. Число подписчиков динамически меняется через вебсокет. Рекламодатель имеет кнопку добавить новый оффер. Вебмастер видит реферальные ссылки своих подписок, которые можно скопировать. При наведении на ссылку показывается ее название. Администратор видит статистику системы и комиссию системы, которую может изменить.

### Статистика

У рекламодателя и веб-мастера на странице */dashboard* есть ссылка на статистику */offer/statistics*, где у рекламодателя отображается временная статистика расходов офферов , у вебмастеров - доходов подписок. За отображение статистики отвечает класс ``App\Http\Controllers\StatisticController``, метод ``index``.
На странице в верстке находятся четыре таблицы статистики (последний день, последний месяц, последний год, все время), но отображается одна. При изменении переключателя времени показывается соответствующая таблица. Сервер формирует данные для страницы статистики через посредник ``App\Services\OfferStatistics``. Данный сервис формирует четыре таблицы для четырех промежутков времени. 

### Система-редиректор SF-AdTech

В рамках работы все доступные реферальные ссылки отображаются на главной странице (если запускать проект через консоль, то http://127.0.0.1:8000/). При запуске проекта через консоль реферальная ссылка имеет вид *http://127.0.0.1:8000/A@B*, где A - id вебмастера, B - id оффера. Посредник ``App\Http\Middleware\IsOfferReference`` проверяет реферальную ссылку на корректность данных. Если такой реферальной ссылки не существует, то редирект на 404 страницу. В противном случае сервер делает запись в таблицу БД ``offer_clicks`` о переходе с указанием времени перехода и переход на страницу рекламодателя. На страницах соответствующего веб-мастера и рекламодателя-создателя оффера обновляется статистика оффера, получив информацию через вебсокет. Факт перехода или ошибочной реферальной ссылки записывается в лог */storage/logs/offer_clicks.log* и обновляет статистику системы (страница администратора) через вебсокет.